{"version":3,"sources":["entities/Rectangle.ts","entities/Region.ts","entities/Category.ts","entities/Label.ts","api/crdbApi.ts","components/CategorySetting.tsx","components/RegionList.tsx","components/RegionEditor/RegionEditorController.ts","components/RegionEditor/index.tsx","utils/manipulateImage.ts","components/RegionEditorContainer.tsx","components/ImageList.tsx","App.tsx","serviceWorker.ts","index.tsx","add_photo_alternate-black-48dp.svg"],"names":["Rectangle","_left","_top","_right","_bottom","width","right","left","height","bottom","top","l","Math","min","this","t","r","max","b","rectangle","value","Region","id","categoryId","label","x","y","abs","deepCopy","convertRegionsToPathRegions","regions","map","region","index","toPoints","convertPointsToRegions","regionObj","horizontalPointList","point","verticalPointList","points","verticalPoints","validate","Category","name","order","_id","_name","_order","Label","_categoryId","_label","BASE_API_ENDPOINT","handleErrors","response","ok","status","Error","fetchHash","imageFile","a","formData","FormData","append","fetch","method","body","then","json","fetchCategories","jsonObj","categories","categoryObj","fetchLabels","labels","labelObj","fetchPageRegionsUrl","imageIds","category","url","fetchPageRegions","console","log","hashes","submitPageRegionsUrl","submitPageRegions","idempotencyKey","regionsObj","JSON","stringify","headers","useStyles","makeStyles","theme","createStyles","root","overflowY","backgroundColor","palette","background","paper","formControl","margin","spacing","minWidth","selectEmpty","marginTop","CategorySetting","props","classes","categorySelect","useRef","getCategories","apis","callback","onCategoriesUpdated","onCategorySelected","getLabels","onLabelsUpdated","useEffect","className","FormControl","InputLabel","Select","selectedCategory","onChange","event","target","categoryList","filter","MenuItem","table","RegionList","regionList","Box","moveOrder","fromIndex","toIndex","resultRegionList","temp","moveOrderDown","newIndex","onChangeRegionList","moveOrderUp","categorySettingCallback","length","TableContainer","component","Paper","Table","aria-label","TableHead","TableRow","TableCell","align","TableBody","key","onClick","onRegionSelected","selectRegion","selectedRegion","selectedOrNot","labelValue","labelList","labelName","IconButton","orderIcons","RegionEditorController","canvas","mode","Array","image","addedRegion","deletedRegion","deformedRegion","_focusedRegion","_editingRegion","_selectedRegion","imageWidth","imageHeight","marginBottom","marginLeft","marginRight","clicking","onMouseDownListener","calcXRatio","offsetX","calcYRatio","offsetY","nearestRegionArray","nearestRegion","editingRegion","createRegion","onSelectedRegion","redraw","onMouseMoveListener","focusedRegion","onMouseUpListener","addRegion","onKeyDownListener","preventDefault","dist","shiftKey","altKey","shrink","metaKey","expand","move","deleteRegion","isNaN","parseInt","selectPrevRegion","selectNextRegion","changeRegionLabel","onKeyUpListener","minMarginPixel","ratio","marginHorizontal","marginVertical","containsPoint","neighborScore","sort","scoreA","scoreB","list","onAddedRegion","deleteIndex","indexOf","slice","onDeletedRegion","count","moveRegion","editingRectangle","endsWith","deform","deformRegionIndex","deformRegion","rect","newLeft","newTop","newRight","newBottom","newRegionList","onDeformRegion","labelRegionIndex","labelRegion","onChangedLabel","ctx","getContext","clearRect","drawImage","forEach","strokeStyle","drawMarkers","drawRegion","topX","centerX","topY","fillRect","leftX","leftY","centerY","rightX","rightY","bottomX","bottomY","fillStyle","drawExpandMarkers","drawShrinkMarkers","strokeRect","canvasContainer","position","cursor","RegionEditor","useState","cacheImage","setImage","regionEditorControllerRef","resizeEvent","current","clientWidth","clientHeight","calcMargin","window","addEventListener","removeEventListener","regionEditorController","document","file","onResizeCompleted","fileReader","FileReader","onload","result","img","Image","src","readAsDataURL","manipulateImage","ref","tabIndex","EditHistory","display","grid","regionEditor","title","flexGrow","menu","useStateRef","initialValue","setValue","RegionEditorContainer","uuidv4","editingFile","setEditingFile","editingCategory","setEditingCategory","isDirty","setDirty","showSaveConfirmDialog","setShowSaveDialog","anchorImportExportMenu","setAnchorImportExportMenu","importInput","setHashes","setCategoryList","setSelectedCategory","setLabelList","selectedRegionState","setSelectedRegion","selectedRegionRef","regionListState","setRegionList","regionListRef","historyListState","setHistoryList","historyListRef","snackbarText","setSnackbarText","open","vertical","horizontal","state","setState","regionEditorCallback","addEditHistory","changedRegion","regionListCallback","newCategoryList","handleError","error","message","getRegions","selectedFile","onlineMode","h","ctrlKey","restoreEditHistory","clearEditHistory","dirty","lastHistoryIndex","latestHistory","newHistoryList","submitRegions","saveRegions","blob","Blob","type","URL","createObjectURL","createElement","appendChild","download","href","click","remove","revokeObjectURL","Fragment","AppBar","Toolbar","Typography","variant","Tooltip","color","onTurnOnlineRequested","handleClose","handleExport","Menu","anchorEl","keepMounted","Boolean","onClose","disabled","currentTarget","accept","files","e","parse","readAsText","hidden","showImportExportMenu","Snackbar","autoHideDuration","anchorOrigin","Grid","container","item","xs","Container","handleSave","handleDiscard","Dialog","aria-labelledby","aria-describedby","DialogTitle","DialogContent","DialogContentText","DialogActions","Button","autoFocus","showSaveDialog","flexWrap","justifyContent","overflow","gridList","transform","imageBoxContainerSelected","border","imageBoxContainer","imageContainer","alignItems","objectFit","imagePlaceholder","boxFile","tapContainer","selectionBox","clearIcon","ImageList","imageFiles","setImageFiles","previewImages","setPreviewImages","fileInput","readFile","GridList","fileInputSnapshot","add_photo_alternate_black","isSelected","onDelete","createPreviewImage","onFileSelected","splice","onFileListUpdated","createPreviewImages","multiple","unshift","main","drawerHeader","padding","mixins","toolbar","grow","textAlign","drawerHeaderShift","transition","transitions","create","easing","easeOut","duration","enteringScreen","drawer","drawerPaper","drawerHeaderPaper","paddingLeft","content","sharp","leavingScreen","contentShift","App","setOnlineMode","imageListShown","setImageListShown","fileList","setFileList","setFile","agreementDate","localStorage","getItem","agreementDialogShown","showAgreementDialog","rootElement","prevFile","currentIndex","nextFile","regionEditorContainerCallback","toggleDrawer","getHashList","f","exportRegions","hashList","onKeyDown","CssBaseline","rel","Drawer","anchor","clsx","elevation","setItem","location","hostname","match","ReactDOM","render","StrictMode","getElementById","navigator","serviceWorker","ready","registration","unregister","catch","module","exports"],"mappings":"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","file":"static/js/main.3b0a284a.chunk.js","sourcesContent":["export class Rectangle {\n\n    private _left = 0;\n    set left(value: number) {\n        this._left = Math.min(Math.max(0, value), 1.0);\n    }\n    get left(): number {\n        return Math.min(this._left, this._right);\n    }\n\n    private _top = 0;\n    set top(value: number) {\n        this._top = Math.min(Math.max(0, value), 1.0);\n    }\n    get top(): number {\n        return Math.min(this._top, this._bottom);\n    }\n\n    private _right = 0;\n    set right(value: number) {\n        this._right = Math.min(Math.max(0, value), 1.0);\n    }\n    get right(): number {\n        return Math.max(this._left, this._right);\n    }\n\n    private _bottom = 0;\n    set bottom(value: number) {\n        this._bottom = Math.min(Math.max(0, value), 1.0);\n    }\n    get bottom(): number {\n        return Math.max(this._top, this._bottom);\n    }\n\n    get centerX(): number {\n        return this.left + this.width() / 2;\n    }\n    get centerY(): number {\n        return this.top + this.height() / 2;\n    }\n\n    width = () => { return this.right - this.left; }\n    height = () => { return this.bottom - this.top; }\n\n    validate() {\n        const l = Math.min(this.left, this.right);\n        const t = Math.min(this.top, this.bottom);\n        const r = Math.max(this.left, this.right);\n        const b = Math.max(this.top, this.bottom);\n\n        this.left = l;\n        this.top = t;\n        this.right = r;\n        this.bottom = b;\n    }\n\n    toString() {\n        return `left: ${this.left}, top: ${this.top}, right: ${this.right}, bottom: ${this.bottom}`\n    }\n\n    toPoints(): Array<{}> {\n        return [\n            {\n                \"x\": this.left,\n                \"y\": this.top,\n            },\n            {\n                \"x\": this.right,\n                \"y\": this.top,\n            },\n            {\n                \"x\": this.right,\n                \"y\": this.bottom,\n            },\n            {\n                \"x\": this.left,\n                \"y\": this.bottom,\n            }\n        ];\n    }\n\n    deepCopy(): Rectangle {\n        const rectangle = new Rectangle();\n        rectangle.left = this.left;\n        rectangle.top = this.top;\n        rectangle.right = this.right;\n        rectangle.bottom = this.bottom;\n\n        return rectangle;\n    }\n}","import { Rectangle } from './Rectangle'\n\nexport class Region {\n\n    id: number;\n    categoryId: number\n    label: number\n    rectangle: Rectangle\n\n    constructor(id: number, categoryId: number, label: number, rectangle: Rectangle) {\n        this.id = id;\n        this.categoryId = categoryId;\n        this.label = label;\n        this.rectangle = rectangle;\n    }\n\n    containsPoint(x: number, y: number): boolean {\n        if (x < this.rectangle.left) {\n            return false;\n        }\n        if (y < this.rectangle.top) {\n            return false;\n        }\n        if (x > this.rectangle.right) {\n            return false;\n        }\n        if (y > this.rectangle.bottom) {\n            return false;\n        }\n        return true;\n    }\n\n    neighborScore(x: number, y: number): number {\n        const l = Math.abs(this.rectangle.left - x);\n        const r = Math.abs(this.rectangle.right - x);\n        const t = Math.abs(this.rectangle.top - y);\n        const b = Math.abs(this.rectangle.bottom - y);\n\n        return Math.min(l, t, r, b)\n    }\n\n    deepCopy(): Region {\n        return new Region(this.id, this.categoryId, this.label, this.rectangle.deepCopy());\n    }\n}\n\nconst ORDER_UNIT = 5;\n\nexport function convertRegionsToPathRegions(regions: Array<Region>) {\n    return regions.map((region: Region, index: number) => {\n        return {\n            \"category_id\": region.categoryId,\n            \"label\": region.label,\n            \"order\": index * ORDER_UNIT,\n            \"points\": region.rectangle.toPoints()\n        }\n    });\n}\n\nfunction horizontalPoints(points: Array<{}>): Array<number> {\n    return points.map((point: any) => {\n        return point['x'] as number\n    });\n}\n\nfunction verticalPoints(points: Array<{}>): Array<number> {\n    return points.map((point: any) => {\n        return point['y'] as number\n    });\n}\n\nexport function convertPointsToRegions(regions): Array<Region> {\n    return regions.map((regionObj: any) => {\n        const id = regionObj['id'] ? regionObj['id'] : -1;\n        const categoryId = regionObj['category_id'];\n        const label = regionObj['label'];\n\n        const horizontalPointList = horizontalPoints(regionObj['points']);\n        const verticalPointList = verticalPoints(regionObj['points']);\n\n        const left = Math.min(...horizontalPointList);\n        const top = Math.min(...verticalPointList);\n        const right = Math.max(...horizontalPointList);\n        const bottom = Math.max(...verticalPointList);\n\n        const rectangle = new Rectangle()\n        rectangle.left = left;\n        rectangle.top = top;\n        rectangle.right = right;\n        rectangle.bottom = bottom;\n        rectangle.validate()\n\n        return new Region(id, categoryId, label, rectangle);\n    });\n}","export class Category {\n\n    private _id = 0;\n    get id(): number {\n        return this._id;\n    }\n\n    private _name = \"\";\n    get name(): string {\n        return this._name;\n    }\n\n    private _order = 0;\n    get order(): number {\n        return this._order;\n    }\n\n    constructor(id: number, name: string, order: number) {\n        this._id = id;\n        this._name = name;\n        this._order = order;\n    }\n}","export class Label {\n\n    private _categoryId = 0;\n    get categoryId(): number {\n        return this._categoryId;\n    }\n\n    private _label = 0;\n    get label(): number {\n        return this._label;\n    }\n\n    private _name = \"\";\n    get name(): string {\n        return this._name;\n    }\n\n    private _order = 0;\n    get order(): number {\n        return this._order;\n    }\n\n    constructor(categoryId: number, label: number, name: string, order: number) {\n        this._categoryId = categoryId;\n        this._label = label;\n        this._name = name;\n        this._order = order;\n    }\n}","import { convertRegionsToPathRegions, convertPointsToRegions, Region } from '../entities/Region';\nimport { Category } from '../entities/Category';\nimport { Label } from '../entities/Label';\n\nconst BASE_API_ENDPOINT = 'https://mrdb.keiji.dev/api/v1'\n\nconst handleErrors = (response: any) => {\n  if (response.ok) {\n    return response;\n  }\n\n  switch (response.status) {\n    case 400: throw Error('INVALID_TOKEN');\n    case 401: throw Error('UNAUTHORIZED');\n    case 500: throw Error('INTERNAL_SERVER_ERROR');\n    case 502: throw Error('BAD_GATEWAY');\n    case 404: throw Error('No region data found.');\n    default: throw Error('UNHANDLED_ERROR');\n  }\n}\n\nexport async function fetchHash(imageFile: File) {\n  const formData = new FormData();\n  formData.append('file', imageFile);\n  const response = await fetch(BASE_API_ENDPOINT + \"/hash\", { method: 'POST', body: formData })\n    .then(handleErrors);\n  return response.json();\n}\n\nexport async function fetchCategories() {\n  const response = await fetch(BASE_API_ENDPOINT + \"/category\")\n    .then(handleErrors);\n  const jsonObj = await response.json();\n  const categories = jsonObj['categories'].map((categoryObj: any) => {\n    const id = categoryObj['id'];\n    const name = categoryObj['name'];\n    const order = categoryObj['order'];\n    return new Category(id, name, order);\n  });\n\n  return categories;\n}\n\nexport async function fetchLabels(categoryId: number) {\n  const response = await fetch(BASE_API_ENDPOINT + `/category/${categoryId}`)\n    .then(handleErrors);\n  const jsonObj = await response.json();\n  const labels = jsonObj['labels'].map((labelObj: any) => {\n    const categoryId = labelObj['category_id'];\n    const label = labelObj['label'];\n    const name = labelObj['name'];\n    const order = labelObj['order'];\n    return new Label(categoryId, label, name, order);\n  });\n\n  return labels;\n}\n\nexport function fetchPageRegionsUrl(imageIds: {}, category: Category | null | undefined) {\n  let url = BASE_API_ENDPOINT + \"/page/\" + imageIds['dhash8'];\n  if (category) {\n    url += `/?category_id=${category.id}`\n  }\n  return url;\n}\n\nexport async function fetchPageRegions(imageIds: {}, category: Category | undefined) {\n  const response = await fetch(fetchPageRegionsUrl(imageIds, category))\n    .then(handleErrors);\n  const jsonObj = await response.json();\n\n  const regions = convertPointsToRegions(jsonObj['regions']);\n  console.log(regions);\n\n  return {\n    hashes: imageIds,\n    regions: regions\n  };\n}\n\nfunction submitPageRegionsUrl(category: Category | undefined) {\n  let url = BASE_API_ENDPOINT + \"/page\";\n  if (category) {\n    url += \"?category_id=\" + category.id;\n  }\n  return url;\n}\n\nexport async function submitPageRegions(\n  idempotencyKey: string,\n  hashes: {},\n  regions: Array<Region>,\n  category: Category | undefined\n) {\n\n  const regionsObj = convertRegionsToPathRegions(regions);\n  const jsonObj = {\n    \"image_ids\": {\n      \"dhash8\": hashes[\"dhash8\"],\n      \"dhash12\": hashes[\"dhash12\"],\n      \"dhash16\": hashes[\"dhash16\"],\n    },\n    \"regions\": regionsObj\n  };\n\n  const body: string = JSON.stringify(jsonObj);\n\n  const response = await fetch(submitPageRegionsUrl(category), {\n    method: 'POST',\n    headers: {\n      \"Idempotency-Key\": idempotencyKey\n    },\n    body: body\n  });\n  return response.json();\n\n}","import { createStyles, FormControl, InputLabel, makeStyles, MenuItem, Select, Theme } from '@material-ui/core';\nimport React, { useEffect, useRef } from 'react';\n\nimport { Category } from '../entities/Category';\nimport * as apis from \"../api/crdbApi\";\nimport { Label } from '../entities/Label';\n\nconst useStyles = makeStyles((theme: Theme) => createStyles({\n    root: {\n        overflowY: `scroll`,\n        backgroundColor: theme.palette.background.paper,\n    },\n    formControl: {\n        margin: theme.spacing(1),\n        minWidth: `120px`,\n    },\n    selectEmpty: {\n        marginTop: theme.spacing(2),\n    },\n}),\n);\n\ntype Props = {\n    categoryList: Array<Category> | null | undefined,\n    selectedCategory: Category | null | undefined,\n    callback: Callback,\n}\n\nexport function CategorySetting(props: Props) {\n    const classes = useStyles();\n\n    const categorySelect = useRef(null);\n\n    const getCategories = async () => {\n        const categories = await apis.fetchCategories();\n        props.callback.onCategoriesUpdated(categories);\n        props.callback.onCategorySelected(categories[0]);\n        getLabels(categories[0]);\n    }\n\n    const getLabels = async (category: Category) => {\n        const labels = await apis.fetchLabels(category.id);\n        props.callback.onLabelsUpdated(labels);\n    }\n\n    useEffect(() => {\n        getCategories();\n    }, [categorySelect]);\n\n    const categorySelected = (event: React.ChangeEvent<{ value: unknown }>) => {\n        const value = event.target.value\n        if (typeof value == `number` && props.categoryList) {\n            const category: Array<Category> = props.categoryList.filter((category: Category) => { return category.id == value });\n            if (category) {\n                props.callback.onCategorySelected(category[0]);\n                getLabels(category[0]);\n            }\n        }\n    }\n\n    const selectedCategoryValue = () => {\n        if (!props.selectedCategory) {\n            return 0;\n        }\n        return props.selectedCategory.id;\n    }\n\n    const categoryList = () => {\n        if (!props.categoryList) {\n            return (<div></div>);\n        }\n        return props.categoryList.map((category: Category, index: number) => (\n            <MenuItem value={category.id}>{category.name}</MenuItem>\n        ));\n    }\n\n    return (\n        <div className={classes.root} >\n            <FormControl className={classes.formControl}>\n                <InputLabel id=\"demo-simple-select-label\">Category</InputLabel>\n                <Select\n                    value={selectedCategoryValue()}\n                    onChange={categorySelected}\n                    className={classes.selectEmpty}\n                >\n                    {categoryList()}\n                </Select>\n            </FormControl>\n        </div>\n    );\n}\n\nexport interface Callback {\n    onCategoriesUpdated(categoryList: Array<Category>): void\n    onCategorySelected(category: Category): void\n\n    onLabelsUpdated(labelList: Array<Label>): void\n}","import React from 'react';\n\nimport {\n    Box, createStyles, IconButton, makeStyles, Paper,\n    Table, TableBody, TableCell, TableContainer, TableHead, TableRow,\n    Theme\n} from '@material-ui/core';\n\nimport { CategorySetting, Callback as CategorySettingCallback } from './CategorySetting';\nimport { Category } from '../entities/Category';\nimport { Region } from '../entities/Region';\nimport { Label } from '../entities/Label';\n\nimport MoveOrderUpIcon from '@material-ui/icons/ExpandLess';\nimport MoveOrderDownIcon from '@material-ui/icons/ExpandMore';\nimport RadioButtonUncheckedIcon from '@material-ui/icons/RadioButtonUnchecked';\nimport RadioButtonCheckedIcon from '@material-ui/icons/RadioButtonChecked';\n\nconst useStyles = makeStyles((theme: Theme) => createStyles({\n    root: {\n        height: `100%`,\n        overflowY: `scroll`,\n        backgroundColor: theme.palette.background.paper,\n    },\n    table: {\n        minWidth: `100%`,\n    },\n}),\n);\n\nexport interface Callback {\n    onChangeRegionList(regionList: Array<Region>): void\n    onCategoriesUpdated(categoryList: Array<Category>): void\n    onRegionSelected(region: Region): void\n}\n\ntype Props = {\n    selectedCategory: Category | undefined,\n    regionList: Array<Region> | undefined,\n    selectedRegion: Region | null,\n    categoryList: Array<Category> | undefined,\n    labelList: Array<Label> | undefined,\n    callback: Callback,\n    categorySettingCallback: CategorySettingCallback\n}\n\nexport function RegionList(props: Props) {\n    const classes = useStyles();\n\n    if (!props.regionList) {\n        return (<Box className={classes.root}></Box>);\n    }\n\n    const moveOrder = (regionList: Array<Region>, fromIndex: number, toIndex: number): Array<Region> => {\n        const resultRegionList = [...regionList];\n\n        const temp = resultRegionList[toIndex];\n        resultRegionList[toIndex] = resultRegionList[fromIndex];\n        resultRegionList[fromIndex] = temp;\n        return resultRegionList;\n    }\n\n    const moveOrderDown = (index: number) => {\n        if (!props.regionList) {\n            return;\n        }\n        const newIndex = index + 1;\n        const regionList = moveOrder(props.regionList, index, newIndex);\n\n        props.callback.onChangeRegionList(regionList);\n    }\n    const moveOrderUp = (index: number) => {\n        if (!props.regionList) {\n            return;\n        }\n        const newIndex = index - 1;\n        const regionList = moveOrder(props.regionList, index, newIndex);\n\n        props.callback.onChangeRegionList(regionList);\n    }\n\n    const orderIcons = (index: number) => {\n        if (!props.regionList) {\n            return;\n        }\n        if (index === 0) {\n            return (\n                <TableCell>\n                    <IconButton onClick={() => { moveOrderDown(index) }}>\n                        <MoveOrderDownIcon />\n                    </IconButton>\n                </TableCell>\n            );\n        } else if (index === (props.regionList.length - 1)) {\n            return (\n                <TableCell>\n                    <IconButton onClick={() => { moveOrderUp(index) }}>\n                        <MoveOrderUpIcon />\n                    </IconButton>\n                </TableCell>\n            );\n        } else {\n            return (\n                <TableCell>\n                    <IconButton onClick={() => { moveOrderUp(index) }}>\n                        <MoveOrderUpIcon />\n                    </IconButton>\n                    <IconButton onClick={() => { moveOrderDown(index) }}>\n                        <MoveOrderDownIcon />\n                    </IconButton>\n                </TableCell>\n            );\n        }\n    }\n\n    const selectedOrNot = (region: Region) => {\n        if (props.selectedRegion === region) {\n            return (<TableCell><RadioButtonCheckedIcon /></TableCell>);\n        }\n        return (<TableCell><RadioButtonUncheckedIcon /></TableCell>);\n\n    }\n\n    const selectRegion = (region: Region) => {\n        props.callback.onRegionSelected(region);\n    }\n\n    const label = (labelValue: number) => {\n        if (!props.labelList) {\n            return (<TableCell>{labelValue}</TableCell>);\n        }\n        const label = props.labelList.filter((label: Label) => { return label.label === labelValue })[0];\n        let labelName: string\n        if (label) {\n            labelName = label.name;\n        } else {\n            labelName = 'Unknown';\n        }\n\n        return (<TableCell>{labelValue}: {labelName}</TableCell>);\n    }\n\n    const showTable = () => {\n        if (!props.regionList || props.regionList.length === 0) {\n            return (<span></span>);\n        }\n\n        return (\n            <TableContainer component={Paper}>\n                <Table className={classes.table} aria-label=\"simple table\">\n                    <TableHead>\n                        <TableRow>\n                            <TableCell></TableCell>\n                            <TableCell>Label</TableCell>\n                            <TableCell align=\"center\">Order</TableCell>\n                        </TableRow>\n                    </TableHead>\n                    <TableBody>\n                        {props.regionList.map((region: Region, index: number) => (\n                            <TableRow key={index} onClick={() => { selectRegion(region) }}>\n                                {selectedOrNot(region)}\n                                {label(region.label)}\n                                {orderIcons(index)}\n                            </TableRow>\n                        ))}\n                    </TableBody>\n                </Table>\n            </TableContainer>\n        );\n    }\n\n    return (\n        <Box className={classes.root}>\n            <CategorySetting\n                categoryList={props.categoryList}\n                selectedCategory={props.selectedCategory}\n                callback={props.categorySettingCallback} />\n\n            {showTable()}\n        </Box>\n    );\n}\n","import { Category } from '../../entities/Category';\nimport { Rectangle } from '../../entities/Rectangle';\nimport { Region } from '../../entities/Region';\n\nconst TICK = 0.01;\nconst NEIGHBOR_THRESHOLD = 0.005;\n\nconst MARKER_LENGTH = 8;\n\ntype Mode = 'move' | 'expand' | 'shrink';\n\nexport class RegionEditorController {\n\n  category: Category | null | undefined = new Category(0, 'Unknown', 0);\n  label = 0;\n\n  private mode: Mode = 'move';\n\n  regionList: Array<Region> | null | undefined = Array();\n  image: HTMLImageElement | null = null;\n\n  private canvas: HTMLCanvasElement\n\n  private callback: Callback = new (class implements Callback {\n    onSelectedRegion(selectedRegion: Region) {\n      // Do nothing\n    }\n    onAddedRegion(addedRegion: Region, regionList: Array<Region>) {\n      // Do nothing\n    }\n    onDeletedRegion(deletedRegion: Region, regionList: Array<Region>) {\n      // Do nothing\n    }\n    onChangedLabel(deletedRegion: Region, regionList: Array<Region>) {\n      // Do nothing\n    }\n    onDeformRegion(deformedRegion: Region, regionList: Array<Region>) {\n      // Do nothing\n    }\n  });\n\n  private _focusedRegion: Region | null = null;\n  set focusedRegion(region: Region | null) {\n    this._focusedRegion = region;\n  }\n  get focusedRegion(): Region | null {\n    return this._focusedRegion;\n  }\n\n  private _editingRegion: Region | null = null;\n  set editingRegion(region: Region | null) {\n    this._editingRegion = region;\n  }\n  get editingRegion(): Region | null {\n    return this._editingRegion;\n  }\n\n  private _selectedRegion: Region | null = null;\n  set selectedRegion(region: Region | null) {\n    this._selectedRegion = region;\n  }\n  get selectedRegion(): Region | null {\n    return this._selectedRegion;\n  }\n\n  private imageWidth = 0;\n  private imageHeight = 0;\n\n  private marginTop = 0;\n  private marginBottom = 0;\n  private marginLeft = 0;\n  private marginRight = 0;\n\n  destroy() {\n    this.image = null;\n  }\n\n  calcMargin(\n    minMarginPixel: number\n  ) {\n    if (!this.image) {\n      return;\n    }\n\n    const ratio = Math.min(\n      this.canvas.width / this.image.width,\n      this.canvas.height / this.image.height\n    );\n\n    let marginHorizontal = this.canvas.width - (this.image.width * ratio);\n    let marginVertical = this.canvas.height - (this.image.height * ratio);\n\n    if (marginHorizontal < minMarginPixel * 2) {\n      marginHorizontal = minMarginPixel * 2;\n    }\n    if (marginVertical < minMarginPixel * 2) {\n      marginVertical = minMarginPixel * 2;\n    }\n\n    this.marginTop = marginVertical / 2;\n    this.marginBottom = marginVertical - this.marginTop;\n    this.marginLeft = marginHorizontal / 2;\n    this.marginRight = marginHorizontal - this.marginLeft;\n\n    this.imageWidth = this.canvas.width - marginHorizontal;\n    this.imageHeight = this.canvas.height - marginVertical;\n  };\n\n  calcXRatio(offsetX: number) {\n    return (offsetX - this.marginLeft) / this.imageWidth;\n  }\n\n  calcYRatio(offsetY: number) {\n    return (offsetY - this.marginTop) / this.imageHeight;\n  }\n\n  private clicking = false;\n\n  onMouseDownListener = (event) => {\n    this.clicking = true;\n\n    const x = this.calcXRatio(event.offsetX);\n    const y = this.calcYRatio(event.offsetY);\n\n    const nearestRegionArray = this.nearestRegion(x, y);\n    if (!nearestRegionArray) {\n      return;\n    }\n\n    if (nearestRegionArray.length > 0) {\n      this.selectedRegion = nearestRegionArray[0];\n    } else {\n      this.selectedRegion = null;\n      this.editingRegion = this.createRegion(x, y);\n    }\n    this.callback.onSelectedRegion(this.selectedRegion);\n    this.redraw();\n  };\n\n  onMouseMoveListener = (event) => {\n\n    const x = this.calcXRatio(event.offsetX);\n    const y = this.calcYRatio(event.offsetY);\n\n    if (this.clicking && this.editingRegion !== null) {\n      this.editingRegion.rectangle.right = x;\n      this.editingRegion.rectangle.bottom = y;\n      this.redraw()\n      return;\n\n    } else if (!this.clicking) {\n      const nearestRegionArray = this.nearestRegion(x, y);\n      if (!nearestRegionArray) {\n        return;\n      }\n\n      if (nearestRegionArray.length > 0) {\n        this.focusedRegion = nearestRegionArray[0];\n      } else {\n        this.focusedRegion = null;\n      }\n      this.redraw()\n      return;\n    }\n  }\n\n  onMouseUpListener = (event) => {\n    this.clicking = false;\n\n    const region = this.editingRegion\n    if (region) {\n      region.rectangle.validate();\n      this.editingRegion = null\n\n      if (region.rectangle.width() < TICK && region.rectangle.height() < TICK) {\n        return;\n      }\n\n      this.addRegion(region);\n    }\n  }\n\n  nearestRegion(x: number, y: number) {\n    if (!this.regionList) {\n      return null;\n    }\n\n    const filteredRegion = this.regionList.filter((region) => {\n      return region.containsPoint(x, y);\n    }).filter((region) => {\n      const score = region.neighborScore(x, y);\n      return score < NEIGHBOR_THRESHOLD;\n    });\n\n    // sort by neighbor score.\n    const sortedRegions = filteredRegion.sort((a, b) => {\n      const scoreA = a.neighborScore(x, y);\n      const scoreB = b.neighborScore(x, y);\n      if (scoreA < scoreB) {\n        return -1;\n      } else if (scoreA > scoreB) {\n        return 1;\n      }\n      return 0;\n    });\n    return sortedRegions;\n  }\n\n  onKeyDownListener = (event) => {\n\n    if (event.key == 'ArrowRight' || event.key == 'ArrowLeft' || event.key == 'ArrowUp' || event.key == 'ArrowDown') {\n      event.preventDefault();\n\n      const dist = TICK * (event.shiftKey ? 0.1 : 1.0);\n\n      if (event.altKey) {\n        this.shrink(event.key, dist);\n      } else if (event.metaKey) {\n        this.expand(event.key, dist);\n      } else {\n        this.move(event.key, dist);\n      }\n\n    } else if (event.key == 'Delete' || event.key == 'Clear' || event.key == 'Backspace' || event.key == 'd') {\n      event.preventDefault();\n\n      if (!this.selectedRegion) {\n        return;\n      }\n      this.deleteRegion(this.selectedRegion);\n\n    } else if (!isNaN(parseInt(event.key))) {\n      event.preventDefault();\n\n      if (!this.selectedRegion) {\n        return;\n      }\n      this.changeRegionLabel(this.selectedRegion, parseInt(event.key));\n\n    } else if (event.key == 'Escape') {\n      event.preventDefault();\n\n      this.editingRegion = null;\n    } else if (event.key == 'Enter') {\n      event.preventDefault();\n\n      if (event.shiftKey) {\n        this.selectPrevRegion();\n      } else {\n        this.selectNextRegion();\n      }\n    } else if (event.key == 'Meta') {\n      event.preventDefault();\n      this.mode = 'expand';\n    } else if (event.key == 'Alt') {\n      event.preventDefault();\n      this.mode = 'shrink';\n    } else {\n      console.log(event.key);\n    }\n\n    this.redraw();\n  }\n\n  onKeyUpListener = (event) => {\n    event.preventDefault();\n\n    if (event.key == 'Meta' && !event.altKey) {\n      this.mode = 'move';\n    } else if (event.key == 'Alt' && !event.metaKey) {\n      this.mode = 'move';\n    }\n\n    this.redraw();\n  }\n\n  addRegion(region: Region) {\n    const list = this.regionList ? this.regionList : Array();\n\n    this.regionList = [...list, region];\n    this.callback.onAddedRegion(region, this.regionList)\n\n    this.selectedRegion = region;\n    this.callback.onSelectedRegion(region);\n  }\n\n  deleteRegion(region: Region) {\n    if (!this.regionList) {\n      return;\n    }\n\n    const deleteIndex = this.regionList.indexOf(region)\n    if (deleteIndex >= 0) {\n      this.regionList = [\n        ...this.regionList.slice(0, deleteIndex),\n        ...this.regionList.slice(deleteIndex + 1, this.regionList.length)\n      ];\n    }\n    this.callback.onDeletedRegion(region, this.regionList)\n\n    this.selectedRegion = null;\n    this.callback.onSelectedRegion(null);\n  }\n\n  moveRegion(count: number) {\n    if (!this.regionList || this.regionList.length == 0) {\n      return;\n    }\n\n    if (this.selectedRegion === null) {\n      this.selectedRegion = this.regionList[0];\n      return;\n    }\n\n    const index = this.regionList.indexOf(this.selectedRegion);\n    if (index > -1) {\n      const toIndex = index + count;\n      if (toIndex >= 0 && toIndex < this.regionList.length) {\n        this.selectedRegion = this.regionList[toIndex];\n        this.callback.onSelectedRegion(this.selectedRegion);\n      }\n    }\n  }\n\n  selectPrevRegion() {\n    this.moveRegion(-1);\n  }\n\n  selectNextRegion() {\n    this.moveRegion(+1);\n  }\n\n  constructor(\n    canvas: HTMLCanvasElement,\n    callback: Callback,\n  ) {\n    this.canvas = canvas;\n    this.callback = callback;\n  }\n\n  createRegion(x: number, y: number) {\n    const editingRectangle = new Rectangle();\n    editingRectangle.left = x;\n    editingRectangle.right = x;\n    editingRectangle.top = y;\n    editingRectangle.bottom = y;\n    const categoryId = this.category ? this.category.id : 0;\n    return new Region(-1, categoryId, this.label, editingRectangle)\n  }\n\n  shrink(key: string, dist: number): boolean {\n    this.mode = 'shrink';\n\n    if (key.endsWith('Left')) {\n      return this.deform(0, 0, -dist, 0);\n    } else if (key.endsWith('Up')) {\n      return this.deform(0, 0, 0, -dist);\n    } else if (key.endsWith('Right')) {\n      return this.deform(dist, 0, 0, 0);\n    } else if (key.endsWith('Down')) {\n      return this.deform(0, dist, 0, 0);\n    }\n    return false;\n  }\n\n  expand(key: string, dist: number): boolean {\n    this.mode = 'expand';\n\n    if (key.endsWith('Left')) {\n      return this.deform(-dist, 0, 0, 0);\n    } else if (key.endsWith('Up')) {\n      return this.deform(0, -dist, 0, 0);\n    } else if (key.endsWith('Right')) {\n      return this.deform(0, 0, dist, 0);\n    } else if (key.endsWith('Down')) {\n      return this.deform(0, 0, 0, dist);\n    }\n\n    return false;\n  }\n\n  move(key: string, dist: number): boolean {\n    this.mode = 'move';\n\n    if (key.endsWith('Left')) {\n      return this.deform(-dist, 0, -dist, 0);\n    } else if (key.endsWith('Up')) {\n      return this.deform(0, -dist, 0, -dist);\n    } else if (key.endsWith('Right')) {\n      return this.deform(dist, 0, dist, 0);\n    } else if (key.endsWith('Down')) {\n      return this.deform(0, dist, 0, dist);\n    }\n\n    return false;\n  }\n\n  deform(left: number, top: number, right: number, bottom: number): boolean {\n    if (!this.regionList || !this.selectedRegion) {\n      return false;\n    }\n\n    const deformRegionIndex = this.regionList.indexOf(this.selectedRegion);\n    if (deformRegionIndex < 0) {\n      return false;\n    }\n\n    const deformRegion = this.selectedRegion.deepCopy();\n    const rect = deformRegion.rectangle;\n\n    let newLeft = rect.left + left;\n    let newTop = rect.top + top;\n    let newRight = rect.right + right;\n    let newBottom = rect.bottom + bottom;\n\n    newLeft = Math.max(0, newLeft);\n    newTop = Math.max(0, newTop);\n    newRight = Math.min(1.0, newRight);\n    newBottom = Math.min(1.0, newBottom);\n\n    if (rect.left === newLeft\n      && rect.top === newTop\n      && rect.right === newRight\n      && rect.bottom === newBottom) {\n      return false;\n    }\n\n    rect.left = newLeft;\n    rect.top = newTop;\n    rect.right = newRight;\n    rect.bottom = newBottom;\n\n    const newRegionList = [\n      ...this.regionList.slice(0, deformRegionIndex),\n      deformRegion,\n      ...this.regionList.slice(deformRegionIndex + 1, this.regionList.length)\n    ];\n    this.regionList = newRegionList;\n    this.selectedRegion = deformRegion;\n\n    this.callback.onDeformRegion(deformRegion, this.regionList);\n    this.callback.onSelectedRegion(this.selectedRegion);\n\n    return true;\n  }\n\n  changeRegionLabel(region: Region, label: number) {\n    this.label = label;\n\n    if (!this.regionList) {\n      return false;\n    }\n\n    const labelRegionIndex = this.regionList.indexOf(region);\n    if (labelRegionIndex < 0) {\n      return false;\n    }\n\n    const labelRegion = region.deepCopy();\n    labelRegion.label = label;\n\n    const newRegionList = [\n      ...this.regionList.slice(0, labelRegionIndex),\n      labelRegion,\n      ...this.regionList.slice(labelRegionIndex + 1, this.regionList.length)\n    ];\n    this.regionList = newRegionList;\n    this.selectedRegion = labelRegion;\n\n    this.callback.onChangedLabel(labelRegion, this.regionList);\n    this.callback.onSelectedRegion(this.selectedRegion);\n\n    return true;\n  }\n\n  redraw() {\n    const ctx = this.canvas.getContext(\"2d\");\n    if (ctx === null) {\n      return;\n    }\n\n    ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n\n    if (!this.image) {\n      return;\n    }\n\n    ctx.drawImage(\n      this.image,\n      this.marginLeft, this.marginTop,\n      this.imageWidth, this.imageHeight\n    );\n\n    if (!this.regionList) {\n      return;\n    }\n\n    this.regionList.forEach((region, index) => {\n      if (region == this.selectedRegion) {\n        ctx.strokeStyle = \"#00FF00\";\n        this.drawMarkers(region, ctx);\n      } else if (region == this.focusedRegion) {\n        ctx.strokeStyle = \"#0000FF\";\n      } else {\n        ctx.strokeStyle = \"#666666\";\n      }\n\n      this.drawRegion(region, ctx);\n    })\n\n    if (this.editingRegion) {\n      ctx.strokeStyle = \"#FF0000\";\n      this.drawRegion(this.editingRegion, ctx);\n    }\n  }\n\n  drawExpandMarkers(region: Region, ctx: CanvasRenderingContext2D) {\n    // top\n    const topX = region.rectangle.centerX * this.imageWidth + this.marginLeft;\n    const topY = region.rectangle.top * this.imageHeight + this.marginTop;\n    ctx.fillRect(topX, topY, 1, -MARKER_LENGTH);\n\n    // left\n    const leftX = region.rectangle.left * this.imageWidth + this.marginLeft;\n    const leftY = region.rectangle.centerY * this.imageHeight + this.marginTop;\n    ctx.fillRect(leftX, leftY, -MARKER_LENGTH, 1);\n\n    // right\n    const rightX = region.rectangle.right * this.imageWidth + this.marginLeft;\n    const rightY = region.rectangle.centerY * this.imageHeight + this.marginTop;\n    ctx.fillRect(rightX, rightY, MARKER_LENGTH, 1);\n\n    // bottom\n    const bottomX = region.rectangle.centerX * this.imageWidth + this.marginLeft;\n    const bottomY = region.rectangle.bottom * this.imageHeight + this.marginTop;\n    ctx.fillRect(bottomX, bottomY, 1, MARKER_LENGTH);\n  }\n\n  drawShrinkMarkers(region: Region, ctx: CanvasRenderingContext2D) {\n    // top\n    const topX = region.rectangle.centerX * this.imageWidth + this.marginLeft;\n    const topY = region.rectangle.top * this.imageHeight + this.marginTop;\n    ctx.fillRect(topX, topY, 1, MARKER_LENGTH);\n\n    // left\n    const leftX = region.rectangle.left * this.imageWidth + this.marginLeft;\n    const leftY = region.rectangle.centerY * this.imageHeight + this.marginTop;\n    ctx.fillRect(leftX, leftY, MARKER_LENGTH, 1);\n\n    // right\n    const rightX = region.rectangle.right * this.imageWidth + this.marginLeft;\n    const rightY = region.rectangle.centerY * this.imageHeight + this.marginTop;\n    ctx.fillRect(rightX, rightY, -MARKER_LENGTH, 1);\n\n    // bottom\n    const bottomX = region.rectangle.centerX * this.imageWidth + this.marginLeft;\n    const bottomY = region.rectangle.bottom * this.imageHeight + this.marginTop;\n    ctx.fillRect(bottomX, bottomY, 1, -MARKER_LENGTH);\n  }\n\n  drawMarkers(region: Region, ctx: CanvasRenderingContext2D) {\n    ctx.fillStyle = \"#00FF00\";\n\n    switch (this.mode) {\n      case \"move\": {\n        return;\n      }\n      case \"expand\": {\n        this.drawExpandMarkers(region, ctx);\n        return;\n      }\n      case \"shrink\": {\n        this.drawShrinkMarkers(region, ctx);\n        return;\n      }\n    }\n  }\n\n  drawRegion(region: Region, ctx: CanvasRenderingContext2D) {\n    const rect = region.rectangle;\n\n    ctx.strokeRect(\n      rect.left * this.imageWidth + this.marginLeft,\n      rect.top * this.imageHeight + this.marginTop,\n      rect.width() * this.imageWidth,\n      rect.height() * this.imageHeight\n    );\n  }\n}\n\nexport interface Callback {\n  onSelectedRegion(region: Region | null);\n  onChangedLabel(region: Region, regionList: Array<Region>);\n\n  onAddedRegion(addedRegion: Region, regionList: Array<Region>);\n  onDeletedRegion(deletedRegion: Region, regionList: Array<Region>);\n  onDeformRegion(deformedRegion: Region, regionList: Array<Region>);\n}\n","import { createStyles, makeStyles, Theme } from '@material-ui/core';\nimport React, { useEffect, useRef, useState } from 'react';\nimport { RegionEditorController, Callback as RegionEditorCallback } from './RegionEditorController';\nimport * as manipulateImage from \"../../utils/manipulateImage\";\nimport { Category } from '../../entities/Category';\nimport { Region } from '../../entities/Region';\n\nconst DEFAULT_LABEL = 0;\nconst DEFAULT_MARGIN = 16;\n\nconst useStyles = makeStyles((theme: Theme) => createStyles({\n    root: {\n        height: `100%`,\n        backgroundColor: theme.palette.background.paper,\n    },\n    canvasContainer: {\n        position: `relative`,\n        height: `100%`,\n        width: `100%`,\n    },\n    canvas: {\n        cursor: `crosshair`,\n    },\n}),\n);\n\ntype Props = {\n    file: File | null | undefined,\n    selectedCategory: Category | undefined,\n    regionList: Array<Region> | undefined,\n    selectedRegion: Region | null,\n    callback: RegionEditorCallback,\n}\n\nexport function RegionEditor(props: Props) {\n    const classes = useStyles();\n\n    const [cacheImage, setImage] = useState<HTMLImageElement | null>(null);\n    const regionEditorControllerRef = useRef<RegionEditorController | null>(null);\n\n    const canvasContainer = useRef<HTMLDivElement>(null);\n    const canvas = useRef<HTMLCanvasElement>(null);\n\n    // add/remove resize listeners\n    useEffect(() => {\n        const resizeEvent = (event) => {\n            if (!canvas.current) {\n                return;\n            }\n            if (!canvasContainer.current) {\n                return;\n            }\n\n            if (cacheImage && regionEditorControllerRef.current) {\n                canvas.current.width = canvasContainer.current.clientWidth;\n                canvas.current.height = canvasContainer.current.clientHeight;\n                regionEditorControllerRef.current.calcMargin(DEFAULT_MARGIN);\n                regionEditorControllerRef.current.redraw();\n            }\n        };\n\n        window.addEventListener(\"resize\", resizeEvent);\n\n        return () => {\n            window.removeEventListener(\"resize\", resizeEvent);\n        }\n    });\n\n    // add/remove mouse and key event listeners\n    useEffect(() => {\n        if (canvas.current) {\n            const regionEditorController = new RegionEditorController(\n                canvas.current,\n                props.callback\n            );\n\n            canvas.current.addEventListener(\"mousedown\", regionEditorController.onMouseDownListener);\n            canvas.current.addEventListener(\"mousemove\", regionEditorController.onMouseMoveListener);\n            canvas.current.addEventListener(\"mouseup\", regionEditorController.onMouseUpListener);\n\n            // https://qiita.com/jay-es/items/cd30c73989659374698a\n            document.addEventListener(\"keydown\", regionEditorController.onKeyDownListener);\n            document.addEventListener(\"keyup\", regionEditorController.onKeyUpListener);\n\n            regionEditorControllerRef.current = regionEditorController;\n        }\n\n        return () => {\n            if (canvas.current && regionEditorControllerRef.current) {\n                const regionEditorController = regionEditorControllerRef.current;\n                canvas.current.removeEventListener(\"mousedown\", regionEditorController.onMouseDownListener);\n                canvas.current.removeEventListener(\"mousemove\", regionEditorController.onMouseMoveListener);\n                canvas.current.removeEventListener(\"mouseup\", regionEditorController.onMouseUpListener);\n\n                document.removeEventListener(\"keydown\", regionEditorController.onKeyDownListener);\n                document.removeEventListener(\"keyup\", regionEditorController.onKeyUpListener);\n            }\n        };;\n\n    }, [canvas]);\n\n    useEffect(() => {\n        if (!props.file) {\n            // reset editor\n            setImage(null);\n            return;\n        }\n\n        manipulateImage.loadImage(props.file, (image: HTMLImageElement) => {\n            setImage(image);\n        });\n\n    }, [props.file]);\n\n    useEffect(() => {\n        if (regionEditorControllerRef.current) {\n            regionEditorControllerRef.current.image = cacheImage;\n            regionEditorControllerRef.current.calcMargin(DEFAULT_MARGIN);\n            regionEditorControllerRef.current.category = props.selectedCategory;\n            regionEditorControllerRef.current.label = DEFAULT_LABEL;\n            regionEditorControllerRef.current.regionList = props.regionList;\n            regionEditorControllerRef.current.redraw();\n        }\n    }, [cacheImage]);\n\n    useEffect(() => {\n        if (!props.regionList || !props.selectedCategory) {\n            return;\n        }\n\n        if (regionEditorControllerRef.current) {\n            regionEditorControllerRef.current.category = props.selectedCategory;\n            regionEditorControllerRef.current.label = DEFAULT_LABEL;\n            regionEditorControllerRef.current.regionList = props.regionList;\n            regionEditorControllerRef.current.redraw();\n        }\n    }, [props.regionList]);\n\n    useEffect(() => {\n        if (!canvas.current) {\n            return;\n        }\n        if (!canvasContainer.current) {\n            return;\n        }\n\n        canvas.current.width = canvasContainer.current.clientWidth;\n        canvas.current.height = canvasContainer.current.clientHeight;\n\n        if (regionEditorControllerRef.current) {\n            regionEditorControllerRef.current.redraw();\n        }\n    }, [canvas, canvasContainer]);\n\n    useEffect(() => {\n        if (regionEditorControllerRef.current) {\n            regionEditorControllerRef.current.selectedRegion = props.selectedRegion;\n            regionEditorControllerRef.current.redraw();\n        }\n    }, [props.selectedRegion]);\n\n    useEffect(() => {\n        if (!props.selectedCategory) {\n            return;\n        }\n\n        if (regionEditorControllerRef.current) {\n            regionEditorControllerRef.current.category = props.selectedCategory;\n        }\n    }, [props.selectedCategory]);\n\n    return (\n        <div className={classes.canvasContainer} ref={canvasContainer}>\n            <canvas className={classes.canvas} tabIndex={-1} ref={canvas} />\n        </div>\n    );\n}\n","\nexport function loadImage(file: File, onResizeCompleted) {\n  const fileReader = new FileReader();\n  fileReader.onload = (event) => {\n    const result = event.target?.result;\n    if (result == null) {\n      return;\n    }\n    const img = new Image();\n    img.src = result as string;\n\n    onResizeCompleted(img);\n  };\n  fileReader.readAsDataURL(file)\n}\n","import React, { Dispatch, MutableRefObject, SetStateAction, useEffect, useRef, useState } from 'react';\nimport { RegionList } from './RegionList';\n\nimport {\n    AppBar, Button, Container, createStyles,\n    Dialog, DialogActions, DialogContent, DialogContentText, DialogTitle,\n    Grid, IconButton, makeStyles, Menu, MenuItem, Snackbar, SnackbarOrigin,\n    Theme, Toolbar, Tooltip, Typography\n} from '@material-ui/core';\nimport { Callback as RegionEditorCallback } from './RegionEditor/RegionEditorController';\nimport { Callback as RegionListCallback } from './RegionList';\nimport { Callback as CategorySettingCallback } from './CategorySetting';\n\nimport * as apis from \"../api/crdbApi\";\nimport { convertPointsToRegions, convertRegionsToPathRegions, Region } from '../entities/Region';\nimport { Label } from '../entities/Label';\nimport { Category } from '../entities/Category';\nimport { RegionEditor } from './RegionEditor/index';\n\nimport UndoIcon from '@material-ui/icons/Undo';\nimport BackupIcon from '@material-ui/icons/Backup';\nimport CloudOffIcon from '@material-ui/icons/CloudOff';\nimport ImportExportIcon from '@material-ui/icons/ImportExport';\n\nimport { v4 as uuidv4 } from 'uuid';\n\nexport class EditHistory {\n    selectedRegion: Region | null\n    regionList: Array<Region>\n\n    constructor(selectedRegion: Region | null, regionList: Array<Region>) {\n        this.selectedRegion = selectedRegion;\n        this.regionList = regionList;\n    }\n}\n\nconst APP_TITLE = \"MRDB - Manga Region Database\";\n\nconst useStyles = makeStyles((theme: Theme) => createStyles({\n    root: {\n        width: `100%`,\n        height: `100%`,\n        backgroundColor: theme.palette.background.paper,\n        display: `flex`,\n    },\n    grid: {\n        top: `64px`,\n        height: `calc(100% - 64px)`,\n    },\n    regionEditor: {\n        height: `100%`,\n        backgroundColor: theme.palette.background.paper,\n        display: `flex`\n    },\n    regionList: {\n        height: `100%`,\n        backgroundColor: theme.palette.background.paper,\n        display: `flex`\n    },\n    title: {\n        flexGrow: 1,\n    },\n    menu: {\n    },\n}),\n);\n\nexport interface State extends SnackbarOrigin {\n    open: boolean;\n}\n\ntype Props = {\n    onlineMode: boolean,\n    selectedFile: File | null | undefined,\n    callback: Callback,\n    className: any\n}\n\n// https://stackoverflow.com/a/58439475\nfunction useStateRef<T>(initialValue: T): [T, Dispatch<SetStateAction<T>>, MutableRefObject<T>] {\n    const [value, setValue] = useState<T>(initialValue);\n\n    const ref = useRef<T>(value);\n\n    useEffect(() => {\n        ref.current = value;\n    }, [value]);\n\n    return [value, setValue, ref];\n}\n\nexport function RegionEditorContainer(props: Props) {\n    const classes = useStyles();\n\n    const idempotencyKey = useRef(uuidv4());\n\n    const [editingFile, setEditingFile] = useState<File | null | undefined>(null);\n    const [editingCategory, setEditingCategory] = useState<Category>()\n\n    const [isDirty, setDirty] = useState(false);\n    const [showSaveConfirmDialog, setShowSaveDialog] = useState(false);\n\n    const [anchorImportExportMenu, setAnchorImportExportMenu] = useState<null | HTMLElement>(null);\n    const importInput = useRef<null | HTMLInputElement>(null);\n\n    const [hashes, setHashes] = useState<{}>()\n\n    const [categoryList, setCategoryList] = useState<Array<Category>>()\n    const [selectedCategory, setSelectedCategory] = useState<Category>()\n\n    const [labelList, setLabelList] = useState<Array<Label>>()\n\n    const [selectedRegionState, setSelectedRegion, selectedRegionRef] = useStateRef<Region | null>(null);\n    const [regionListState, setRegionList, regionListRef] = useStateRef(new Array<Region>());\n    const [historyListState, setHistoryList, historyListRef] = useStateRef(new Array<EditHistory>());\n\n    const [snackbarText, setSnackbarText] = useState<string>(\"Hello\")\n\n    const [state, setState] = useState<State>({\n        open: false,\n        vertical: 'top',\n        horizontal: 'center',\n    });\n    const { vertical, horizontal, open } = state;\n\n    const init = () => {\n        setDirty(false);\n        setHashes({});\n        setRegionList(Array());\n        setHistoryList(Array());\n    }\n\n    const regionEditorCallback = new (class implements RegionEditorCallback {\n        onSelectedRegion(selectedRegion: Region | null) {\n            setSelectedRegion(selectedRegion)\n        }\n        onAddedRegion(addedRegion: Region, newRegionList: Array<Region>) {\n            addEditHistory(selectedRegionRef.current, regionListRef.current);\n            setRegionList(newRegionList);\n        }\n        onDeletedRegion(deletedRegion: Region, newRegionList: Array<Region>) {\n            addEditHistory(selectedRegionRef.current, regionListRef.current);\n            setRegionList(newRegionList);\n        }\n        onChangedLabel(changedRegion: Region, newRegionList: Array<Region>) {\n            addEditHistory(selectedRegionRef.current, regionListRef.current);\n            setRegionList(newRegionList);\n        }\n        onDeformRegion(deformedRegion: Region, newRegionList: Array<Region>) {\n            addEditHistory(selectedRegionRef.current, regionListRef.current);\n            setRegionList(newRegionList);\n        }\n    })();\n\n    const regionListCallback = new (class implements RegionListCallback {\n        onChangeRegionList(newRegionList: Region[]): void {\n            addEditHistory(selectedRegionRef.current, regionListRef.current);\n            setRegionList(newRegionList);\n        }\n        onCategoriesUpdated(categoryList: Category[]): void {\n            const newCategoryList = [...categoryList];\n            setCategoryList(newCategoryList);\n        }\n        onRegionSelected(region: Region): void {\n            setSelectedRegion(region);\n        }\n    })();\n\n    const categorySettingCallback = new (class implements CategorySettingCallback {\n        onCategoriesUpdated(categoryList: Category[]): void {\n            const newCategoryList = [...categoryList];\n            setCategoryList(newCategoryList);\n        }\n        onCategorySelected(category: Category): void {\n            setSelectedCategory(category);\n        }\n        onLabelsUpdated(labelList: Label[]): void {\n            setLabelList(labelList);\n        }\n    })();\n\n    const handleError = (error: Error) => {\n        switch (error.message) {\n            case \"Failed to fetch\": {\n                setSnackbarText(\"A network error has occurred.\");\n                setState({ ...state, open: true });\n                break;\n            }\n            default: {\n                setSnackbarText(`${error.message}`);\n                setState({ ...state, open: true });\n                break;\n            }\n        }\n    }\n\n    const getRegions = async () => {\n        if (!props.selectedFile) {\n            return;\n        }\n\n        setRegionList(new Array<Region>());\n\n        if (!props.onlineMode) {\n            return;\n        }\n\n        try {\n            const h = await apis.fetchHash(props.selectedFile);\n            setHashes(h);\n\n            const result = await apis.fetchPageRegions(h, selectedCategory);\n            if (h === result.hashes) {\n                setRegionList(result.regions);\n            }\n        } catch (error) {\n            handleError(error);\n        }\n    }\n\n    useEffect(() => {\n        const onKeyDownListener = (event) => {\n            event.preventDefault();\n\n            if (event.key == 'z' && (event.ctrlKey || event.metaKey)) {\n                restoreEditHistory();\n            }\n        }\n\n        document.addEventListener(\"keydown\", onKeyDownListener);\n\n        return () => {\n            document.removeEventListener(\"keydown\", onKeyDownListener);\n        };\n    });\n\n    useEffect(() => {\n        if (!props.selectedFile) {\n            init();\n            setEditingFile(props.selectedFile);\n            return;\n        }\n\n        if (isDirty) {\n            setShowSaveDialog(true);\n            return;\n        }\n\n        setEditingFile(props.selectedFile);\n    }, [props.selectedFile]);\n\n    useEffect(() => {\n        if (!selectedCategory) {\n            return;\n        }\n\n        if (isDirty) {\n            setShowSaveDialog(true);\n            return;\n        }\n\n        setEditingCategory(selectedCategory);\n    }, [selectedCategory]);\n\n    useEffect(() => {\n        getRegions();\n    }, [props.onlineMode]);\n\n    useEffect(() => {\n        idempotencyKey.current = uuidv4();\n        clearEditHistory();\n\n        if (editingFile) {\n            getRegions();\n        }\n    }, [editingFile, editingCategory]);\n\n    useEffect(() => {\n        const dirty = historyListState.length > 0;\n        setDirty(dirty);\n\n    }, [historyListState]);\n\n    const clearEditHistory = () => {\n        setHistoryList(Array());\n    }\n\n    const restoreEditHistory = () => {\n        if (historyListState.length == 0) {\n            return;\n        }\n\n        const lastHistoryIndex = historyListState.length - 1;\n        const latestHistory = historyListState[lastHistoryIndex];\n        setRegionList(latestHistory.regionList);\n        setSelectedRegion(latestHistory.selectedRegion);\n\n        const newHistoryList = [...historyListState.slice(0, lastHistoryIndex)];\n        setHistoryList(newHistoryList);\n    }\n\n    const addEditHistory = (selectedRegion, regionList) => {\n        const newHistoryList = [...historyListRef.current, new EditHistory(selectedRegion, regionList)];\n        setHistoryList(newHistoryList);\n    }\n\n    const submitRegions = async () => {\n        if (!props.selectedFile) {\n            return;\n        }\n        if (!regionListState) {\n            return;\n        }\n\n        try {\n            if (!hashes) {\n                const h = await apis.fetchHash(props.selectedFile);\n                setHashes(h);\n            }\n            if (!hashes) {\n                return;\n            }\n\n            await apis.submitPageRegions(idempotencyKey.current, hashes, regionListState, selectedCategory);\n\n            setSnackbarText(\"Save completed.\");\n            setState({ ...state, open: true });\n            setDirty(false);\n        } catch (error) {\n            handleError(error);\n        }\n    };\n\n    const saveRegions = async () => {\n        if (!props.selectedFile) {\n            return;\n        }\n\n        if (!regionListState) {\n            return;\n        }\n\n        const regionsObj = convertRegionsToPathRegions(regionListState);\n        const jsonObj = {\n            \"file\": props.selectedFile.name,\n            \"regions\": regionsObj\n        }\n\n        if (hashes) {\n            jsonObj[\"image_ids\"] = {\n                \"dhash8\": hashes[\"dhash8\"],\n                \"dhash12\": hashes[\"dhash12\"],\n                \"dhash16\": hashes[\"dhash16\"],\n            }\n        }\n\n        const blob = new Blob([JSON.stringify(jsonObj, null, '  ')], { type: 'application\\/json' });\n        const url = URL.createObjectURL(blob);\n\n        const a = document.createElement(\"a\");\n        document.body.appendChild(a);\n        a.download = props.selectedFile.name + '.json';\n        a.href = url;\n        a.click();\n        a.remove();\n\n        URL.revokeObjectURL(url);\n    };\n\n    const title = () => {\n        if (!props.selectedFile) {\n            return APP_TITLE;\n        }\n        return props.selectedFile.name\n    }\n\n    const onSnackbarClose = () => {\n        setState({ ...state, open: false });\n    }\n\n    const undo = () => {\n        restoreEditHistory();\n    }\n\n    const menu = () => {\n        const showUndoMenu = () => {\n            if (!historyListState) {\n                return (<span></span>);\n            }\n            if (historyListState.length == 0) {\n                return (<span></span>);\n            }\n\n            return (\n                <Tooltip title=\"Undo (Ctrl + Z)\" aria-label=\"undo\">\n                    <IconButton color=\"inherit\" onClick={() => { undo(); }}>\n                        <UndoIcon />\n                    </IconButton>\n                </Tooltip>\n            );\n        };\n\n        const showServerMenu = () => {\n            const turnOnline = () => {\n                props.callback.onTurnOnlineRequested();\n            }\n\n            if (!props.onlineMode) {\n                return (\n                    <Tooltip title=\"Turn to online\" aria-label=\"turn-online-on\">\n                        <IconButton color=\"inherit\" onClick={turnOnline}>\n                            <CloudOffIcon />\n                        </IconButton>\n                    </Tooltip>\n                );\n            }\n\n            if (!isDirty) {\n                return (<span></span>);\n            }\n\n            return (\n                <Tooltip title=\"Save to server\" aria-label=\"submit-to-server\">\n                    <IconButton color=\"inherit\" onClick={submitRegions}>\n                        <BackupIcon />\n                    </IconButton>\n                </Tooltip>\n            );\n        };\n\n        const showImportExportMenu = () => {\n            if (!editingFile) {\n                return;\n            }\n\n            const handleClick = (event: React.MouseEvent<HTMLButtonElement>) => {\n                setAnchorImportExportMenu(event.currentTarget);\n            }\n            const handleClose = () => {\n                setAnchorImportExportMenu(null);\n            }\n\n            const handleImport = () => {\n                handleClose();\n\n                if (!importInput.current) {\n                    return;\n                }\n                importInput.current.click();\n            }\n            const handleExport = () => {\n                handleClose();\n\n                saveRegions();\n            }\n\n            const handleChangeFile = (event) => {\n                event.preventDefault();\n\n                if (!regionListState) {\n                    return;\n                }\n\n                const files = event.target.files;\n                if (!files) {\n                    return;\n                }\n\n                const file = files[0];\n\n                var fileReader = new FileReader();\n                fileReader.onload = (e) => {\n                    const result = e.target?.result;\n                    if (!result) {\n                        return;\n                    }\n                    if (typeof result === 'string') {\n                        const jsonObj = JSON.parse(result as string);\n                        const regions = convertPointsToRegions(jsonObj['regions']);\n                        setRegionList(regions);\n                    }\n\n                    if (importInput.current) {\n                        importInput.current.value = \"\";\n                    }\n                };\n\n                fileReader.readAsText(file);\n            }\n\n            const showExportMenu = () => {\n                const disabled = (!regionListRef.current || regionListRef.current.length == 0);\n                if (disabled) {\n                    return (<MenuItem disabled onClick={handleExport}>Export</MenuItem>);\n                }\n                return (<MenuItem onClick={handleExport}>Export</MenuItem>);\n            }\n\n            return (\n                <span>\n                    <Menu\n                        id=\"simple-menu\"\n                        anchorEl={anchorImportExportMenu}\n                        keepMounted\n                        open={Boolean(anchorImportExportMenu)}\n                        onClose={handleClose}\n                    >\n                        <MenuItem onClick={handleImport}>Import</MenuItem>\n                        {showExportMenu()}\n                    </Menu >\n                    <Tooltip title=\"Export region data\" aria-label=\"export-regions\">\n                        <IconButton color=\"inherit\" onClick={handleClick}>\n                            <ImportExportIcon />\n                        </IconButton>\n                    </Tooltip>\n                    <input\n                        ref={importInput}\n                        type=\"file\"\n                        name=\"files[]\"\n                        id=\"file\"\n                        accept=\"application/json\"\n                        onChange={handleChangeFile}\n                        hidden\n                    />\n                </span >\n            );\n        }\n\n        return (\n            <div className={classes.menu}>\n                {showUndoMenu()}\n                {showServerMenu()}\n                {showImportExportMenu()}\n            </div>\n        );\n    }\n\n    const showSaveDialog = () => {\n        const handleSave = () => {\n            if (props.onlineMode) {\n                submitRegions();\n            } else {\n                saveRegions();\n            }\n\n            setRegionList(Array());\n            setShowSaveDialog(false);\n            setEditingFile(props.selectedFile);\n            setEditingCategory(selectedCategory);\n        }\n\n        const handleDiscard = () => {\n            setRegionList(Array());\n\n            setShowSaveDialog(false);\n            setEditingFile(props.selectedFile);\n            setEditingCategory(selectedCategory);\n        }\n\n        const showSaveButton = () => {\n            if (props.onlineMode) {\n                return (\n                    <DialogActions>\n                        <Button onClick={handleDiscard} color=\"primary\">\n                            Discard\n                        </Button>\n                        <Button onClick={handleSave} color=\"primary\" autoFocus>\n                            Save\n                        </Button>\n                    </DialogActions>\n                );\n            } else {\n                return (\n                    <DialogActions>\n                        <Button onClick={handleDiscard} color=\"primary\">\n                            Discard\n                        </Button>\n                        <Button onClick={handleSave} color=\"primary\" autoFocus>\n                            Save\n                        </Button>\n                    </DialogActions>\n                );\n            }\n        }\n        return (\n            <Dialog\n                open={showSaveConfirmDialog}\n                aria-labelledby=\"alert-dialog-title\"\n                aria-describedby=\"alert-dialog-description\"\n            >\n                <DialogTitle id=\"alert-dialog-title\">Save changes?</DialogTitle>\n                <DialogContent>\n                    <DialogContentText id=\"alert-dialog-description\">\n                        Do you want to save changes before opening an other file?\n              </DialogContentText>\n                </DialogContent>\n\n                {showSaveButton()}\n            </Dialog>\n        );\n    }\n\n    return (\n        <React.Fragment>\n            <AppBar position=\"static\">\n                <Toolbar>\n                    <Typography variant=\"h6\" className={classes.title}>\n                        {title()}\n                    </Typography>\n                    {menu()}\n                </Toolbar>\n            </AppBar>\n\n            <Snackbar\n                open={open}\n                onClose={onSnackbarClose}\n                message={snackbarText}\n                autoHideDuration={2000}\n                anchorOrigin={{ vertical, horizontal }}\n                key={vertical + horizontal}\n            />\n            <Grid container spacing={0} className={classes.grid}>\n                <Grid item xs={8} className={classes.regionEditor}>\n                    <RegionEditor\n                        file={editingFile}\n                        selectedCategory={editingCategory}\n                        regionList={regionListState}\n                        selectedRegion={selectedRegionState}\n                        callback={regionEditorCallback}\n                    />\n                </Grid>\n                <Grid item xs={4} className={classes.regionList} >\n                    <Container>\n                        <RegionList\n                            regionList={regionListState}\n                            selectedRegion={selectedRegionState}\n                            categoryList={categoryList}\n                            selectedCategory={editingCategory}\n                            labelList={labelList}\n                            callback={regionListCallback}\n                            categorySettingCallback={categorySettingCallback}\n                        />\n                    </Container>\n                </Grid>\n\n            </Grid>\n\n            {showSaveDialog()}\n\n        </React.Fragment>\n    );\n}\n\nexport interface Callback {\n    onTurnOnlineRequested(): void\n}","import React, { useState, useRef } from 'react';\n\nimport { Box, Container, GridList, IconButton } from '@material-ui/core';\nimport { makeStyles, Theme, createStyles } from '@material-ui/core/styles';\n\nimport ClearIcon from '@material-ui/icons/Clear';\n\nimport add_photo_alternate_black from '../add_photo_alternate-black-48dp.svg';\n\n\nconst useStyles = makeStyles((theme: Theme) => createStyles({\n    root: {\n        display: 'flex',\n        flexWrap: 'wrap',\n        justifyContent: 'space-around',\n        overflow: 'hidden',\n        backgroundColor: theme.palette.background.paper,\n    },\n    gridList: {\n        flexWrap: 'nowrap',\n        // Promote the list into his own layer on Chrome. This cost memory but helps keeping high FPS.\n        transform: 'translateZ(0)',\n    },\n    imageBoxContainerSelected: {\n        border: `1px solid #0000ff !important;`,\n    },\n    imageBoxContainer: {\n        width: `200px`,\n        height: `100%`,\n        minWidth: `150px`,\n        margin: `8px`,\n        border: `1px solid #cccccc`,\n        position: `relative`,\n    },\n    imageContainer: {\n        width: `100%`,\n        height: `100%`,\n        display: `flex`,\n        alignItems: `center`,\n        position: `absolute`,\n    },\n    image: {\n        objectFit: `cover`,\n        width: `100%`,\n        height: `auto`,\n        marginLeft: `auto`,\n        marginRight: `auto`,\n    },\n    imagePlaceholder: {\n        marginLeft: `auto`,\n        marginRight: `auto`,\n    },\n    boxFile: {\n        display: `none`,\n    },\n    tapContainer: {\n        width: `100%`,\n        height: `100%`,\n        position: `absolute`,\n        display: `flex`,\n        justifyContent: `flex-end`,\n        alignItems: `start`,\n    },\n    selectionBox: {\n        width: `100%`,\n        height: `100%`,\n        position: `absolute`,\n    },\n    clearIcon: {\n    },\n}),\n);\n\ntype Props = {\n    selectedFile: File | null | undefined,\n    callback: Callback,\n}\n\nexport function ImageList(props: Props) {\n    const classes = useStyles();\n\n    const [imageFiles, setImageFiles] = useState(Array<File>());\n    const [previewImages, setPreviewImages] = useState(Array<string | ArrayBuffer>());\n\n    const fileInput = useRef<HTMLInputElement>(null)\n\n    const showFileDialog = () => {\n        const fileInputSnapshot = fileInput.current;\n        if (!fileInputSnapshot) {\n            return;\n        }\n        fileInputSnapshot.click();\n    }\n\n    function changeFile(event: any) {\n        event.preventDefault();\n\n        const files = event.target.files;\n        imageFiles.unshift(...files);\n        imageFiles.forEach((imageFile, index) => {\n            readFile(index);\n        });\n        setImageFiles([...imageFiles]);\n        props.callback.onFileListUpdated(imageFiles)\n    }\n\n    const readFile = (index: number) => {\n        if (!previewImages) {\n            return;\n        }\n\n        const fileReader = new FileReader();\n        fileReader.onload = (event) => {\n            const result = event.target?.result;\n            if (!result) {\n                return;\n            }\n            previewImages[index] = result;\n            setPreviewImages([...previewImages])\n        };\n        fileReader.readAsDataURL(imageFiles[index]);\n    };\n\n    const createPreviewImage = (image: string, classes, isSelected: boolean, onClick: (event: any) => void, onDelete: (event: any) => void) => {\n        const imageBoxClassName = () => {\n            if (isSelected) {\n                return (classes.imageBoxContainerSelected + ` ` + classes.imageBoxContainer);\n            } else {\n                return (classes.imageBoxContainer);\n            }\n        }\n        return (\n            <Box className={imageBoxClassName()}>\n                <Container className={classes.imageContainer}>\n                    <img className={classes.image} src={image} />\n                </Container>\n                <Box className={classes.tapContainer} >\n                    <Box className={classes.selectionBox} onClick={onClick} />\n                    <IconButton className={classes.clearIcon} color=\"inherit\" onClick={onDelete}>\n                        <ClearIcon />\n                    </IconButton>\n                </Box>\n            </Box>\n        )\n    }\n\n    const createPreviewImages = (classes, callback: Callback) => {\n        if (!previewImages) {\n            return;\n        }\n\n        return (\n            previewImages.map((image, index: number) => {\n                const file = imageFiles[index];\n                const onSelect = (event: any) => {\n                    event.preventDefault();\n\n                    callback.onFileSelected(file);\n                };\n                const onDelete = (event: any) => {\n                    event.preventDefault();\n\n                    const index = imageFiles.indexOf(file);\n                    if (index == -1) {\n                        return;\n                    }\n\n                    imageFiles.splice(index, 1);\n                    previewImages.splice(index, 1);\n\n                    setImageFiles([...imageFiles]);\n                    setPreviewImages([...previewImages])\n\n                    props.callback.onFileListUpdated(imageFiles)\n                };\n                if (typeof image === 'string') {\n                    return createPreviewImage(\n                        image, classes,\n                        (file == props.selectedFile),\n                        onSelect, onDelete);\n                }\n            })\n        )\n    }\n\n    return (\n        <div className={classes.root}>\n            <GridList className={classes.gridList}>\n\n                <Box className={classes.imageBoxContainer}>\n                    <Box className={classes.imageContainer} onClick={showFileDialog}>\n                        <img className={classes.imagePlaceholder} src={add_photo_alternate_black} />\n                    </Box>\n                </Box>\n\n                {createPreviewImages(classes, props.callback)}\n                <input\n                    ref={fileInput}\n                    className={classes.boxFile}\n                    type=\"file\"\n                    name=\"files[]\"\n                    id=\"file\"\n                    accept=\"image/*\"\n                    multiple\n                    onChange={changeFile}\n                />\n            </GridList>\n        </div>\n    );\n}\n\nexport interface Callback {\n    onFileSelected(file: File): void\n    onFileListUpdated(fileList: Array<File>): void\n}","import React, { useRef, useState } from 'react';\n\nimport clsx from 'clsx';\nimport { Drawer, IconButton, CssBaseline, Paper, Box, Dialog, DialogContent, DialogTitle, DialogContentText, DialogActions, Button, Typography, Tooltip } from '@material-ui/core';\n\nimport { makeStyles, Theme, createStyles } from '@material-ui/core/styles';\n\nimport OpenDrawerIcon from '@material-ui/icons/ExpandLess';\nimport CloseDrawerIcon from '@material-ui/icons/ExpandMore';\nimport NavigateNextIcon from '@material-ui/icons/NavigateNext';\nimport NavigateBeforeIcon from '@material-ui/icons/NavigateBefore';\nimport SaveAltIcon from '@material-ui/icons/SaveAlt';\n\nimport { RegionEditorContainer, Callback as RegionEditorContainerCallback } from './components/RegionEditorContainer';\nimport { ImageList, Callback } from './components/ImageList';\n\nimport * as apis from \"./api/crdbApi\";\n\n// https://techracho.bpsinc.jp/hachi8833/2019_10_09/80851\nconst KEY_AGREEMENT = 'agreement';\nconst LATEST_AGREEMENT_DATE = '20201006';\n\nconst drawerHeight = 210;\nconst drawerHeaderHeight = 64;\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      display: 'block',\n      height: `100vh`,\n    },\n    main: {\n      height: `calc(100% - ${drawerHeaderHeight}px)`,\n      width: `100%`,\n    },\n    drawerHeader: {\n      display: 'flex',\n      alignItems: 'center',\n      padding: theme.spacing(1, 1),\n      justifyContent: 'flex-end',\n      position: `fixed`,\n      ...theme.mixins.toolbar,\n      top: 'auto',\n      bottom: `0px`,\n      width: `100%`,\n      backgroundColor: theme.palette.background.paper,\n    },\n    grow: {\n      flexGrow: 1,\n      textAlign: `center`,\n    },\n    drawerHeaderShift: {\n      marginBottom: `calc(${drawerHeight}px)`,\n      transition: theme.transitions.create(['margin', 'height'], {\n        easing: theme.transitions.easing.easeOut,\n        duration: theme.transitions.duration.enteringScreen,\n      }),\n    },\n    drawer: {\n    },\n    drawerPaper: {\n      height: drawerHeight,\n    },\n    drawerHeaderPaper: {\n      paddingLeft: `16dp`,\n    },\n    content: {\n      flexGrow: 1,\n      padding: theme.spacing(3),\n      transition: theme.transitions.create('margin', {\n        easing: theme.transitions.easing.sharp,\n        duration: theme.transitions.duration.leavingScreen,\n      }),\n      marginBottom: -drawerHeight,\n    },\n    contentShift: {\n      transition: theme.transitions.create(['margin', 'height'], {\n        easing: theme.transitions.easing.easeOut,\n        duration: theme.transitions.duration.enteringScreen,\n      }),\n      marginBottom: `calc(${drawerHeight}px)`,\n    },\n  }),\n);\n\n\nfunction App() {\n  const [onlineMode, setOnlineMode] = useState(true);\n\n  const [imageListShown, setImageListShown] = useState(true);\n  const [fileList, setFileList] = useState<Array<File>>();\n\n  const [selectedFile, setFile] = useState<File | null>();\n\n  const agreementDate = localStorage.getItem(KEY_AGREEMENT);\n  const [agreementDialogShown, showAgreementDialog] = useState(agreementDate ? !(agreementDate === LATEST_AGREEMENT_DATE) : true);\n\n  const rootElement = useRef<HTMLDivElement>(null);\n\n  const classes = useStyles();\n\n  const prevFile = () => {\n    if (!selectedFile) {\n      return\n    }\n    if (!fileList) {\n      return\n    }\n    const currentIndex = fileList.indexOf(selectedFile)\n    if (currentIndex < 0) {\n      return;\n    }\n\n    const index = currentIndex - 1;\n    if (index >= 0) {\n      setFile(fileList[index]);\n    }\n  }\n\n  const nextFile = () => {\n    if (!selectedFile) {\n      return\n    }\n    if (!fileList) {\n      return\n    }\n    const currentIndex = fileList.indexOf(selectedFile)\n    if (currentIndex < 0) {\n      return;\n    }\n\n    const index = currentIndex + 1;\n    if (index < fileList.length) {\n      setFile(fileList[index]);\n    }\n  }\n\n  const callback = new (class implements Callback {\n    onFileListUpdated(fileList: File[]): void {\n      setFileList(fileList);\n\n      if (!selectedFile) {\n        return;\n      }\n\n      // The selected file is removed from list.\n      if (fileList.indexOf(selectedFile) == -1) {\n        setFile(null);\n      }\n    }\n\n    onFileSelected(file: File) {\n      setFile(file);\n    }\n  });\n\n  const regionEditorContainerCallback = new (class implements RegionEditorContainerCallback {\n    onTurnOnlineRequested(): void {\n      showAgreementDialog(true);\n    }\n  });\n\n  const toggleDrawer = () => {\n    setImageListShown(!imageListShown);\n  }\n\n  const getHashList = async (fileList: Array<File>) => {\n    const result: { [key: string]: {} } = {};\n\n    for (const f of fileList) {\n      const imageIds = await apis.fetchHash(f);\n      result[f.name] = {\n        \"image_ids\": imageIds,\n        \"url\": apis.fetchPageRegionsUrl(imageIds, null)\n      };\n    }\n    return result;\n  }\n\n  const exportRegions = async () => {\n    if (!fileList) {\n      return;\n    }\n\n    const hashList = await getHashList(fileList)\n\n    const blob = new Blob([JSON.stringify(hashList, null, '  ')], { type: 'application\\/json' });\n    const url = URL.createObjectURL(blob);\n\n    const a = document.createElement(\"a\");\n    document.body.appendChild(a);\n    a.download = 'export.json';\n    a.href = url;\n    a.click();\n    a.remove();\n\n    URL.revokeObjectURL(url);\n  }\n\n  const onKeyDownListener = (event) => {\n    if (event.key == ' ') {\n      event.preventDefault();\n      toggleDrawer();\n    }\n  }\n\n  const agreementDialog = () => {\n    const handleAgree = () => {\n      setOnlineMode(true);\n      localStorage.setItem(KEY_AGREEMENT, LATEST_AGREEMENT_DATE);\n      showAgreementDialog(false);\n    }\n    const handleDisagree = () => {\n      setOnlineMode(false);\n      showAgreementDialog(false);\n    }\n\n    return (\n      <Dialog\n        open={agreementDialogShown}\n        aria-labelledby=\"alert-dialog-title\"\n        aria-describedby=\"alert-dialog-description\"\n      >\n        <DialogTitle id=\"alert-dialog-title\">Online mode(Agreement)</DialogTitle>\n        <DialogContent>\n          <DialogContentText id=\"alert-dialog-description\">\n            In online mode, image files will be uploaded to our server for generate image-ids by \"imagehash\" algorithm.\n            And image files will be stored for improving our services.<br />\n            ROI(Region of Interest) data and image-ids will be uploaded, stored, and redistribute for all users.<br />\n            <br />\n            We <strong>DO NOT</strong> redistribute your image files.\n          </DialogContentText>\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={handleDisagree} color=\"primary\">\n            Decline (Continue offline)\n          </Button>\n          <Button onClick={handleAgree} color=\"primary\">\n            Agree\n          </Button>\n        </DialogActions>\n      </Dialog>\n    );\n  }\n\n  const showExportButton = () => {\n    if (!onlineMode) {\n      return (<span></span>);\n    }\n\n    return (\n      <Tooltip title=\"Export all image-IDs\" aria-label=\"export-image-ids\">\n        <IconButton color=\"inherit\" onClick={exportRegions}>\n          <SaveAltIcon />\n        </IconButton>\n      </Tooltip>\n    );\n  }\n  const showButtons = () => {\n    if (!fileList || fileList.length == 0) {\n      return (<Box></Box>);\n    }\n    return (\n      <Box>\n        <Tooltip title=\"Prev file\" aria-label=\"prev-file\">\n          <IconButton color=\"inherit\" onClick={prevFile}>\n            <NavigateBeforeIcon />\n          </IconButton>\n        </Tooltip>\n        <Tooltip title=\"Next file\" aria-label=\"next-file\">\n          <IconButton color=\"inherit\" onClick={nextFile}>\n            <NavigateNextIcon />\n          </IconButton>\n        </Tooltip>\n\n        {showExportButton()}\n      </Box>\n    );\n  }\n\n  const toggleDrawerTitle = () => {\n    return imageListShown ? \"Close (Space)\" : \"Open (Space)\";\n  }\n\n  return (\n    <div className=\"App\" ref={rootElement} onKeyDown={onKeyDownListener} tabIndex={-1}>\n      <CssBaseline />\n\n      <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap\" />\n      <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/icon?family=Material+Icons\" />\n\n      <div className={classes.root}>\n        <Drawer\n          className={classes.drawer}\n          variant=\"persistent\"\n          anchor=\"bottom\"\n          open={imageListShown}\n          classes={{\n            paper: classes.drawerPaper,\n          }}\n        >\n          <ImageList\n            selectedFile={selectedFile}\n            callback={callback} />\n        </Drawer>\n\n        <main className={classes.main}>\n          <RegionEditorContainer\n            selectedFile={selectedFile}\n            onlineMode={onlineMode}\n            callback={regionEditorContainerCallback}\n            className={clsx(classes.content, {\n              [classes.contentShift]: imageListShown,\n            })}\n          />\n        </main>\n      </div>\n\n      <Paper elevation={1} className={clsx(classes.drawerHeaderPaper, classes.drawerHeader, {\n        [classes.drawerHeaderShift]: imageListShown,\n      })}>\n        <Tooltip title={toggleDrawerTitle()} aria-label=\"toggle-drawer\">\n          <IconButton onClick={toggleDrawer} color=\"inherit\" aria-label=\"open drawer\">\n            {!imageListShown ? <OpenDrawerIcon /> : <CloseDrawerIcon />}\n          </IconButton>\n        </Tooltip>\n\n        <div className={classes.grow}>\n          <Typography variant='caption'>Copyright 2020 Keiji ARIYAMA (C-LIS CO., LTD.)</Typography>\n        </div>\n\n        {showButtons()}\n      </Paper>\n\n      {agreementDialog()}\n\n    </div>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      process.env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' }\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","module.exports = __webpack_public_path__ + \"static/media/add_photo_alternate-black-48dp.51e18df8.svg\";"],"sourceRoot":""}